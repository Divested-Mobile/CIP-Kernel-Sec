description: |-
  Linux kernel: Exploitable memory corruption due to UFO to non-UFO path
  switch. When building a UFO packet with MSG_MORE __ip_append_data() calls
  ip_ufo_append_data() to append. However in between two send() calls, the
  append path can be switched from UFO to non-UFO one, which leads to a
  memory corruption. In case UFO packet lengths exceeds MTU, copy =
  maxfraglen - skb->len becomes negative on the non-UFO path and the branch
  to allocate new skb is taken. This triggers fragmentation and computation
  of fraggap = skb_prev->len - maxfraglen. Fraggap can exceed MTU, causing
  copy = datalen - transhdrlen - fraggap to become negative. Subsequently
  skb_copy_and_csum_bits() writes out-of-bounds. A similar issue is present
  in IPv6 code. The bug was introduced in e89e9cf539a2 ("[IPv4/IPv6]: UFO
  Scatter-gather approach") on Oct 18 2005.
references:
- https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-1000112
- https://git.kernel.org/pub/scm/linux/kernel/git/davem/net.git/commit/?id=85f1bd9a7b5a79d5baa8bf44af19658f7bf77bfa
- http://www.ubuntu.com/usn/usn-3384-1
- http://www.ubuntu.com/usn/usn-3384-2
- http://www.ubuntu.com/usn/usn-3385-1
- http://www.ubuntu.com/usn/usn-3385-2
- http://www.ubuntu.com/usn/usn-3386-1
- http://www.ubuntu.com/usn/usn-3386-2
- http://www.openwall.com/lists/oss-security/2017/08/10/5
- https://usn.ubuntu.com/usn/usn-3384-1
- https://usn.ubuntu.com/usn/usn-3384-2
- https://usn.ubuntu.com/usn/usn-3385-1
- https://usn.ubuntu.com/usn/usn-3385-2
- https://usn.ubuntu.com/usn/usn-3386-1
- https://usn.ubuntu.com/usn/usn-3386-2
comments:
  Debian-bwh: |-
    Exploitation is possible by unprivileged users after commit 40ba330227ad
    "udp: disallow UFO for sockets with SO_NO_CHECK option", or with
    CAP_NET_ADMIN (in any namespace).  This is low severity for 3.2 and also
    will be hard to fix there without revisiting CVE-2013-4470.
  Debian-carnil: Introduced in e89e9cf539a28df7d0eb1d0a545368e9920b34ac
  Ubuntu-sbeattie: 'fix subject: udp: consistently apply ufo or fragmentation'
  Ubuntu-smb: |-
    While working on the embargoed CVE we decided that Precise cannot be
    exploited due to the missing user namespace support.
reporters:
- Andrey Konovalov
introduced-by:
  mainline: [e89e9cf539a28df7d0eb1d0a545368e9920b34ac]
fixed-by:
  linux-3.10.y: [69ddef7b41fdad8123a9a4a6eb2a1aa57aafc92b]
  linux-3.16.y: [08676246d893e3a42a541a2ef1291f2ea62c5b06]
  linux-3.18.y: [4ac8dc208caf85675f0f745783e0a3f88dac0008]
  linux-4.12.y: [2a8c396a689114da0fb9164cd07b13fd5b800782]
  linux-4.4.y: [938990d2433cdecd225e1ab54a442b3ffdce1f87]
  linux-4.9.y: [33dc6a6a85f1d6ce71e7056d009b8a5fcbf10f70]
  mainline: [85f1bd9a7b5a79d5baa8bf44af19658f7bf77bfa]
ignore:
  linux-3.2.y: Low severity and difficult to backport
